<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for src/utils/importer.js</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../../index.html">All files</a> / <a href="index.html">src/utils</a> importer.js
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">83.87% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>78/93</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">70% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>21/30</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">68.42% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>13/19</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">83.53% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>71/85</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128</td><td class="line-coverage quiet"><span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40011x</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">2x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-yes">40011x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">40011x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">52x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-yes">20002x</span>
<span class="cline-any cline-yes">20002x</span>
<span class="cline-any cline-yes">2000x</span>
<span class="cline-any cline-yes">2000x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-yes">200x</span>
<span class="cline-any cline-yes">200x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">200x</span>
<span class="cline-any cline-yes">200x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">20003x</span>
<span class="cline-any cline-yes">20x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-yes">6x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-yes">7x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1x</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">const Promise = require('bluebird');
const _ = require('lodash');
const util = require('util');
const fs = require('fs');
const path = require('path');
const jsonStream = require('JSONStream');
const debug = require('debug')('express-cassandra');
&nbsp;
const importer = {
  buildTableQueryForDataRow(keyspace, tableInfo, row) {
    row = _.omitBy(row, (item) =&gt; (item === null));
    let query = util.format('INSERT INTO "%s"."%s" ("%s") VALUES (?%s)', keyspace, tableInfo.name, _.keys(row).join('","'), _.repeat(',?', _.keys(row).length - 1));
    let params = _.values(row);
    if (tableInfo.isCounterTable) {
      const primaryKeyFields = _.pick(row, tableInfo.primaryKeys);
      const otherKeyFields = _.omit(row, tableInfo.primaryKeys);
      const setQueries = _.map(_.keys(otherKeyFields), (key) =&gt; util.format('"%s"="%s" + ?', key, key));
      const whereQueries = _.map(_.keys(primaryKeyFields), (key) =&gt; util.format('"%s"=?', key));
      query = util.format('UPDATE "%s"."%s" SET %s WHERE %s', keyspace, tableInfo.name, setQueries.join(', '), whereQueries.join(' AND '));
      params = _.values(otherKeyFields).concat(_.values(primaryKeyFields));
    }
    params = _.map(params, (param) =&gt; {
      <span class="missing-if-branch" title="if path not taken" >I</span>if (_.isPlainObject(param)) {
<span class="cstat-no" title="statement not covered" >        if (param.type === 'Buffer') {</span>
<span class="cstat-no" title="statement not covered" >          return Buffer.from(param);</span>
        }
        const omittedParams = <span class="cstat-no" title="statement not covered" >_.omitBy(param, <span class="cstat-no" title="statement not covered" ><span class="fstat-no" title="function not covered" >(item) =&gt; (item === null));</span></span></span>
<span class="cstat-no" title="statement not covered" >        Object.keys(omittedParams).forEach(<span class="fstat-no" title="function not covered" >(key) =&gt; {</span></span>
<span class="cstat-no" title="statement not covered" >          if (_.isObject(omittedParams[key]) &amp;&amp; omittedParams[key].type === 'Buffer') {</span>
<span class="cstat-no" title="statement not covered" >            omittedParams[key] = Buffer.from(omittedParams[key]);</span>
          }
        });
<span class="cstat-no" title="statement not covered" >        return omittedParams;</span>
      }
      return param;
    });
    return { query, params };
  },
&nbsp;
  processTableImport(systemClient, fixtureDirectory, keyspace, table, batchSize) {
    return new Promise((resolve, reject) =&gt; {
      debug('==================================================');
      debug(`Reading metadata for table: ${table}`);
      systemClient.metadata.getTable(keyspace, table)
        .then((tableInfo) =&gt; {
          <span class="missing-if-branch" title="if path not taken" >I</span>if (!tableInfo) {
<span class="cstat-no" title="statement not covered" >            resolve();</span>
<span class="cstat-no" title="statement not covered" >            return;</span>
          }
          const isCounterTable = _.some(tableInfo.columns, (column) =&gt; (column.type.code === 5));
          if (isCounterTable) batchSize = 1;
          let primaryKeys = [];
          primaryKeys = primaryKeys.concat(_.map(tableInfo.partitionKeys, (item) =&gt; item.name));
          primaryKeys = primaryKeys.concat(_.map(tableInfo.clusteringKeys, (item) =&gt; item.name));
          tableInfo.isCounterTable = isCounterTable;
          tableInfo.primaryKeys = primaryKeys;
&nbsp;
          let queryPromises = [];
          let queries = [];
          let processed = 0;
&nbsp;
          debug(`Creating read stream from: ${table}.json`);
          const jsonfile = fs.createReadStream(path.join(fixtureDirectory, `${table}.json`), { encoding: 'utf8' });
          const readStream = jsonfile.pipe(jsonStream.parse('*'));
          readStream.on('data', (row) =&gt; {
            processed++;
&nbsp;
            const query = this.buildTableQueryForDataRow(keyspace, tableInfo, row);
            if (batchSize &gt; 1) {
              queries.push(query);
              if (queries.length &gt;= batchSize) {
                queryPromises.push(systemClient.batch(queries, { prepare: true }));
                queries = [];
              }
            } else {
              queryPromises.push(systemClient.execute(query.query, query.params, { prepare: true }));
            }
&nbsp;
            const processPauseSize = (batchSize &gt;= 10) ? batchSize * 10 : 100;
            if (processed % processPauseSize === 0) {
              readStream.pause();
              Promise.all(queryPromises)
                .then(() =&gt; {
                  queryPromises = [];
                  readStream.resume();
                })
                .catch(<span class="fstat-no" title="function not covered" >(err) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >                  reject(err);</span>
                });
            }
&nbsp;
            if (processed % 1000 === 0) {
              debug(`Streaming ${processed} rows to table: ${table}`);
            }
          });
          readStream.on('error', <span class="fstat-no" title="function not covered" >(err) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >            reject(err);</span>
          });
&nbsp;
          const startTime = Date.now();
          readStream.on('end', () =&gt; {
            debug(`Streaming ${processed} rows to table: ${table}`);
            if (queries.length &gt; 1) {
              queryPromises.push(systemClient.batch(queries, { prepare: true }));
            } else <span class="missing-if-branch" title="if path not taken" >I</span>if (queries.length === 1) {
<span class="cstat-no" title="statement not covered" >              queryPromises.push(systemClient.execute(queries[0].query, queries[0].params, { prepare: true }));</span>
            }
            Promise.all(queryPromises)
              .then(() =&gt; {
                const timeTaken = (Date.now() - startTime) / 1000;
                const throughput = timeTaken ? processed / timeTaken : 0.00;
                debug(`Done with table, throughput: ${throughput.toFixed(1)} rows/s`);
                resolve();
              })
              .catch(<span class="fstat-no" title="function not covered" >(err) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >                reject(err);</span>
              });
          });
        })
        .catch(<span class="fstat-no" title="function not covered" >(err) =&gt; {</span>
<span class="cstat-no" title="statement not covered" >          reject(err);</span>
        });
    });
  },
};
&nbsp;
module.exports = importer;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="https://istanbul.js.org/" target="_blank">istanbul</a> at Tue Jul 10 2018 11:43:57 GMT+0600 (+06)
</div>
</div>
<script src="../../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../../sorter.js"></script>
</body>
</html>
